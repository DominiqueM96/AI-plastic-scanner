<!DOCTYPE html>
<html>

<head>
    <title>Analyze Sample</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body id="mybody">
    <div id="smartphone">
        <div id="content">

            <h1>Scan je afval voor tips!</h1>
            <div id="buttons">
                <button onclick="startWebcam();">Start scan</button>
                <button id="takeSnap" disabled>Neem een foto</button>
                <button onclick="stopWebcam();">Stop scan</button>
            </div>

            <video width=360 height=410 id="video" controls autoplay></video>

            <div>
                <canvas id="sourceImage"></canvas>
                <pre id="responseArea"></pre>
            </div>

            <script type="text/javascript">
                var subscriptionKey = "b7e94ff8495e46fda5290c72bd07da16";
                var endpoint = "https://westeurope.api.cognitive.microsoft.com/";
                var uriBase = endpoint + "vision/v2.0/analyze";
                var webcamStream;

                // Request parameters.
                var params = {
                    "visualFeatures": "Description",

                };

                //                functie start webcam 
                //                eerst toestemming vragen
                //                dan de knop voor een foto maken aanzetten

                function startWebcam() {
                    var vid = document.querySelector('video');
                    // request cam
                    navigator.mediaDevices.getUserMedia({
                            video: true
                        })
                        .then(stream => {

                            webcamStream = stream;
                            vid.srcObject = stream;
                            return vid.play();
                        })
                        .then(() => {
                            // knop voor foto maken aanzetten
                            var btn = document.querySelector('#takeSnap');
                            btn.disabled = false;
                            btn.onclick = e => {
                                takeSnap()
                                    .then(blob => {
                                        analyseImage(blob, params, showResults);
                                    })
                            };
                        })
                        .catch(e => console.log('error: ' + e));
                }


                //                nieuwe functie om een foto te maken
                //                dan foto zichtbaar maken

                function takeSnap() {
                    // get video element
                    var vid = document.querySelector('video');
                    // get canvas element
                    var canvas = document.querySelector('canvas');
                    // get its context
                    var ctx = canvas.getContext('2d');
                    // set its size to the one of the video
                    canvas.width = vid.videoWidth;
                    canvas.height = vid.videoHeight;
                    // show snapshot on canvas
                    ctx.drawImage(vid, 0, 0);
                    // show spinner image below
                    //                    document.querySelector('#spinner').classList.remove('hidden');
                    return new Promise((res, rej) => {
                        // request a Blob from the canvas
                        canvas.toBlob(res, 'image/jpeg');
                    });
                }

                //                nieuwe functie om de webcam weer te stoppen
                //                en de knop om een foto te maken weer uit

                function stopWebcam() {
                    var vid = document.querySelector('video');
                    vid.srcObject.getTracks().forEach((track) => {
                        track.stop();
                    });
                    // foto maken knop uit
                    document.querySelector('#takeSnap').disabled = true;
                }


                //                nieuwe functie om de foto te analyseren op plastic
                //                we gebruiker de cognitive services van Microsoft hiervoor

                function analyseImage(image, params, proccessingFunction) {

                    // maak een API url door params toe te voegen
                    var paramString = Object.entries(params).map(([key, val]) => `${key}=${val}`).join('&');
                    var urlWithParams = uriBase + "?" + paramString;

                    // doe een API call
                    fetch(urlWithParams, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/octet-stream",
                                "Ocp-Apim-Subscription-Key": subscriptionKey
                            },
                            processData: false,
                            body: image,
                        })
                        // response veranderen in json
                        .then(response => response.json())
                        // naar processingFunction gaan
                        .then(json => proccessingFunction(json))
                        // laat een alert window zien als er iets fout gaat
                        .catch(error => alert(error.message));
                }

                //                functie om de resultaten te laten zien
                //                met een reactie in json

                function showResults(json) {

                    console.log(json.description.tags)

                    const beschrijving = json.description.tags;

                    //                    array filteren op het woord plastic

                    const filterItems = (letters) => {
                        return beschrijving.filter(name => name.indexOf(letters) > -1);
                    }

                    var afvalzien = console.log(filterItems('plastic'));
                    var afval = filterItems('plastic');

                    var p = document.createElement('p');

                    //                     if else statement om verschillend feedback te geven bij plastic dan een ander soort afval

                    if (afval == "plastic") {
                        console.log('ja');

                        //                        een tekstwolk met tips maken wanneer er plastic wordt herkend

                        p.textContent = "Gebruik in plaats van een plastic tasje herbruikbare zakjes voor groente en fruit";
                        p.setAttribute('class', 'note');
                        document.body.appendChild(p);

                        //                        achtergrond kleur veranderen wanneer er plastic wordt herkend

                        document.getElementById("content").style.backgroundColor = "#FFAD76";
                        document.getElementById("smartphone").style.backgroundColor = "#FFAD76";

                    } else {
                        console.log('nee');

                        //                        een tekstwolk met tips maken wanneer er geen plastic wordt herkend
                        p.textContent = "Goed bezig! Ga zo door en help de aarde in leven te houden. ";
                        p.setAttribute('class', 'note');
                        document.body.appendChild(p);

                        //                        achtergrond kleur veranderen wanneer er geen plastic wordt herkend

                        document.getElementById("content").style.backgroundColor = "#9ACD32";
                        document.getElementById("smartphone").style.backgroundColor = "#9ACD32";

                    }

                }
            </script>
        </div>
    </div>
</body>


</html>
